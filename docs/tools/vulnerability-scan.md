# Vulnerability Scan Tool

The Vulnerability Scan tool analyses source code projects and their dependencies for known security vulnerabilities using Anchore Grype, always saving detailed reports to a specified file and returning a concise summary for efficient AI-assisted development workflows.

## Overview

Essential for security analysis during development, this tool scans project dependencies, SBOM files, or individual packages to identify known vulnerabilities. Perfect for integration with CI/CD pipelines, security workflows, and development environments where AI agents need to assess project security posture.

## Features

- **Source Code Scanning**: Analyse project dependencies from source code
- **SBOM Integration**: Scan existing Software Bill of Materials files
- **Package URL Support**: Analyse individual packages by Package URL
- **Multiple Output Formats**: JSON, table, SARIF, and CycloneDX formats
- **Fixed-Only Filtering**: Focus on vulnerabilities with available fixes
- **File-First Operation**: Always saves detailed reports to specified file, returns summary
- **Absolute Path Requirements**: Consistent file path handling for MCP environments
- **Security-First Design**: Disabled by default, explicitly enabled via environment variable

## Prerequisites

This tool is disabled by default. Enable it by including `vulnerability_scan` in the `ENABLE_ADDITIONAL_TOOLS` environment variable.

## Tool Usage Examples

While intended to be activated via a prompt to an agent, below are some example JSON tool calls.

### Scan Project Directory
```json
{
  "name": "vulnerability_scan",
  "arguments": {
    "source": "/Users/developer/my-project",
    "output_file": "/Users/developer/vulnerability-report.json"
  }
}
```

### Scan SBOM File
```json
{
  "name": "vulnerability_scan",
  "arguments": {
    "source": "sbom:/Users/developer/reports/project-sbom.json",
    "output_file": "/Users/developer/vulnerability-report.sarif",
    "output_format": "sarif"
  }
}
```

### Focus on Fixable Vulnerabilities
```json
{
  "name": "vulnerability_scan",
  "arguments": {
    "source": "/Users/developer/web-app",
    "only_fixed": true,
    "output_file": "/Users/developer/security/fixable-vulns.json"
  }
}
```

### Analyse Specific Package
```json
{
  "name": "vulnerability_scan",
  "arguments": {
    "source": "pkg:npm/lodash@4.17.21",
    "output_format": "table"
  }
}
```

## Parameters Reference

### Core Parameters
| Parameter       | Type    | Default | Required | Description                                     |
|-----------------|---------|---------|----------|-------------------------------------------------|
| `source`        | string  | -       | Yes      | Source to scan (directory, SBOM file, or pkg)   |
| `output_format` | string  | "json"  | No       | Report format (json/table/sarif/cyclonedx-json) |
| `only_fixed`    | boolean | false   | No       | Only report vulnerabilities with fixes          |
| `output_file`   | string  | -       | Yes      | Absolute path to save report                    |

### Source Parameter Options

#### Directory Scanning
```json
{
  "source": "/absolute/path/to/project"
}
```
- Must be absolute path
- Directory must contain package manager files
- Automatically generates SBOM first, then scans

#### SBOM File Scanning
```json
{
  "source": "sbom:/absolute/path/to/sbom.json"
}
```
- Must use `sbom:` prefix
- File path must be absolute
- Supports Syft JSON, SPDX, and CycloneDX formats

#### Package URL Scanning
```json
{
  "source": "pkg:npm/package-name@version"
}
```
- Standard Package URL format
- Examples: `pkg:npm/lodash@4.17.21`, `pkg:maven/com.fasterxml.jackson.core/jackson-core@2.13.0`

### Output Format Options

| Format         | Description                        | Best For                    |
|----------------|------------------------------------|-----------------------------|
| `json`         | Comprehensive vulnerability data   | Programmatic analysis       |
| `table`        | Human-readable tabular format      | Quick manual review         |
| `sarif`        | Static Analysis Results format     | IDE integration, toolchains |
| `cyclonedx-json` | CycloneDX vulnerability extension | Security toolchain integration |

## Response Format

### Standard JSON Response
```json
{
  "scan_metadata": {
    "scanner": "grype",
    "severity_breakdown": {
      "critical": 0,
      "high": 1,
      "low": 0,
      "medium": 0,
      "negligible": 0,
      "unknown": 0
    },
    "timestamp": "2025-08-08T09:25:18+10:00",
    "vulnerability_count": 1
  },
  "vulnerabilities": [
    {
      "description": "@actions/download-artifact has an Arbitrary File Write via artifact extraction",
      "fix": {
        "state": "fixed",
        "versions": [
          "4.1.3"
        ]
      },
      "id": "GHSA-cxww-7g56-2vh6",
      "package": {
        "name": "actions/download-artifact",
        "type": "github-action",
        "version": "v4"
      },
      "severity": "high"
    }
  ],
  "vulnerability_report_format": "json"
}
```

### Table Format Response
```
┌─────────────────┬──────────┬─────────────────┬─────────────┬──────────────────┐
│ Vulnerability   │ Severity │ Package         │ Version     │ Fixed In         │
├─────────────────┼──────────┼─────────────────┼─────────────┼──────────────────┤
│ CVE-2021-44228  │ Critical │ log4j-core      │ 2.14.1      │ 2.17.0           │
│ CVE-2021-45046  │ High     │ log4j-core      │ 2.14.1      │ 2.17.0           │
└─────────────────┴──────────┴─────────────────┴─────────────┴──────────────────┘
```

## Common Use Cases

### Development Security Assessment
Analyse current project for security issues:
```json
{
  "name": "vulnerability_scan",
  "arguments": {
    "source": "/Users/developer/api-service",
    "output_format": "json"
  }
}
```

### CI/CD Security Gates
Focus on actionable vulnerabilities in pipelines:
```json
{
  "name": "vulnerability_scan",
  "arguments": {
    "source": "/home/ci/workspace/app",
    "only_fixed": true,
    "output_format": "sarif",
    "output_file": "/home/ci/reports/security.sarif"
  }
}
```

### Dependency Risk Assessment
Evaluate specific package versions:
```json
{
  "name": "vulnerability_scan",
  "arguments": {
    "source": "pkg:maven/org.apache.struts/struts2-core@2.5.20",
    "output_format": "table"
  }
}
```

### SBOM-Based Security Review
Scan existing Software Bill of Materials:
```json
{
  "name": "vulnerability_scan",
  "arguments": {
    "source": "sbom:/Users/security/audit/project-sbom.json",
    "output_format": "cyclonedx-json",
    "output_file": "/Users/security/reports/vuln-report.json"
  }
}
```

## Workflow Integration

### Security-First Development Workflow
```bash
# 1. Generate SBOM for project
sbom --source="/Users/dev/my-app" --output_file="/Users/dev/reports/app-sbom.json"

# 2. Scan SBOM for vulnerabilities
vulnerability_scan --source="sbom:/Users/dev/reports/app-sbom.json" --only_fixed=true

# 3. Store security findings
memory create_entities --namespace="security" --data='{"entities": [{"name": "MyApp_Security_Status", "observations": ["3 critical vulnerabilities found", "All have available fixes"]}]}'

# 4. Generate actionable report
vulnerability_scan --source="sbom:/Users/dev/reports/app-sbom.json" --only_fixed=true --output_format="table" --output_file="/Users/dev/security/action-items.txt"
```

### Pre-Deployment Security Check
```bash
# 1. Scan production-ready code
vulnerability_scan --source="/Users/deploy/production-app" --only_fixed=true

# 2. Generate compliance report
vulnerability_scan --source="/Users/deploy/production-app" --output_format="cyclonedx-json" --output_file="/Users/deploy/compliance/vuln-report.json"

# 3. Check individual high-risk packages
vulnerability_scan --source="pkg:npm/express@4.17.1"
```

### Security Research Workflow
```bash
# 1. Research package security
package_search --ecosystem="npm" --query="express" --includeDetails=true

# 2. Analyse specific versions
vulnerability_scan --source="pkg:npm/express@4.18.0"
vulnerability_scan --source="pkg:npm/express@4.19.0"

# 3. Document findings
think "Express 4.18.0 has 2 medium vulnerabilities, but 4.19.0 resolves them. Recommend upgrading."
```

## Advanced Features

### SBOM Integration Workflow
The tool integrates seamlessly with SBOM generation:
1. **Generate SBOM**: Use the SBOM tool to create dependency inventory
2. **Scan SBOM**: Use this tool with `sbom:` prefix for faster subsequent scans
3. **Iterate**: Modify dependencies and re-scan existing SBOM

### Output Format Selection Strategy

**JSON Format**: Best for programmatic processing
- Comprehensive vulnerability data
- Machine-readable structure
- Integration with security tools

**Table Format**: Best for human review
- Quick visual assessment
- Easy to understand severity levels
- Suitable for reports and documentation

**SARIF Format**: Best for IDE and toolchain integration
- Static analysis standard format
- Supported by major IDEs (VS Code, IntelliJ)
- Compatible with GitHub Security tab

**CycloneDX Format**: Best for security toolchain integration
- Industry standard vulnerability format
- Compatible with vulnerability management platforms
- Suitable for compliance reporting

## Error Handling

### Path Validation Errors
```json
{
  "error": "source path must be absolute: ./relative/path",
  "suggestion": "Use absolute paths like /Users/username/project"
}
```

### SBOM File Errors
```json
{
  "error": "SBOM file does not exist: /path/to/missing.json",
  "suggestion": "Generate SBOM first or verify file path"
}
```

### Package URL Errors
```json
{
  "error": "Invalid package URL format: npm/lodash@4.17.21",
  "suggestion": "Use proper Package URL format: pkg:npm/lodash@4.17.21"
}
```

## Performance Considerations

### Directory Scanning
- **First scan**: Creates SBOM then scans (slower)
- **Large projects**: May take 2-5 minutes
- **Database updates**: Initial download can add delay

### SBOM Scanning
- **Faster**: No dependency discovery needed
- **Consistent**: Same SBOM gives same results
- **Efficient**: Recommended for repeated scans

### Package URL Scanning
- **Fastest**: Single package analysis
- **Immediate**: No project parsing required
- **Precise**: Exact version vulnerability data

## Security Considerations

- **Absolute Paths**: Required for consistent MCP tool behaviour
- **Disabled by Default**: Explicitly enable via environment variable
- **Path Traversal Protection**: Prevents access outside allowed paths
- **File Creation Security**: Output files created with secure permissions
- **Network Access**: May require internet for vulnerability database updates

## Configuration

### Environment Variables
- **`ENABLE_ADDITIONAL_TOOLS`**: Must include `vulnerability_scan` to enable tool
- **Example**: `ENABLE_ADDITIONAL_TOOLS="vulnerability_scan,sbom"`

### Performance Tuning
- **Use SBOM workflow**: Generate SBOM once, scan multiple times
- **Focus searches**: Use `only_fixed=true` for actionable results
- **Choose format wisely**: JSON for processing, table for review

---

For technical implementation details, see the [Vulnerability Scan source documentation](../../internal/tools/vulnerabilityscan/).
